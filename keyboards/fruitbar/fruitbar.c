/* Copyright 2021 Brandon Lewis
  * 
  * This program is free software: you can redistribute it and/or modify 
  * it under the terms of the GNU General Public License as published by 
  * the Free Software Foundation, either version 2 of the License, or 
  * (at your option) any later version. 
  * 
  * This program is distributed in the hope that it will be useful, 
  * but WITHOUT ANY WARRANTY; without even the implied warranty of 
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
  * GNU General Public License for more details. 
  * 
  * You should have received a copy of the GNU General Public License 
  * along with this program.  If not, see <http://www.gnu.org/licenses/>. 
  */

#include "fruitbar.h"

enum layers {
	_BASE,
	_FN
};

bool encoder_update_kb(uint8_t index, bool clockwise) {
    if (!encoder_update_kb(index, clockwise)) { return false; }
	if(index == 0) {
		if (clockwise) {
			tap_code(KC_VOLD);
		} else {
			tap_code(KC_VOLU);
			}
		}
	return true;
}


const uint32_t FRAME_DATA[][128] = {
  {
    0b00000000000000000000000000000110,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000011001,0b01000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000100010,0b01110000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000001111100,0b01011000000000000000000000000000,0b00000000111111111000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011111000,0b01001100000000000000000000000000,0b00000001111111111111000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011001110,0b01100110000000000000000000000000,0b00000001100000000111000000111110,0b00000000000000000000000000000000,
    0b00000000000000000000000001000011,0b00110110000000000000000000000000,0b00000001100000000011000111111111,0b00000011000000000000000000000000,
    0b00000000000000000000000001000011,0b11111101111000000000100000000000,0b00000001100000000011000111100011,0b00000011111110000000000000000000,
    0b00000000000000000000000001100011,0b11111111111111000000011000000000,0b00000001100000000011000000000011,0b00000000111111000000000000000000,
    0b00000000000000000000000000111111,0b10111110000001110000010000000000,0b00000001100000000011000000000011,0b00000000000111000000000000000000,
    0b00000000000000000000000000011100,0b01100000000000011100100001000000,0b00000011111111110111000000000011,0b00000000000110000000000000000000,
    0b00000000000000000000000011000000,0b00000000000000000110000111000000,0b00000001111111111110000000000011,0b00011111111110000000000000000000,
    0b00000000000000000000000110000000,0b01000000000000000011000000010000,0b00000000000010111110000001111111,0b00011111111100000000000000000000,
    0b00000000000000000000001100000000,0b00100000000011000001100001110000,0b00000000000110000000000011111110,0b00011000000000000000000000000000,
    0b00000000000000000000001000000000,0b01110000000000000000110000000000,0b00000111111111100000000111000000,0b00111000000000000000000000000000,
    0b00000000000000000000010000000000,0b01001000000000010000010000000000,0b00000111111111111110000111000000,0b00111111111000000000000000000000,
    0b00000000000000000000010000000011,0b10100100000000111000011000000000,0b00000000000000011110000110000000,0b00001111111100000000000000000000,
    0b00000000000000000000110000000011,0b00110011000000111000001000000000,0b00000011111111100000000110000000,0b00000000001000000000000000000000,
    0b00000000000000000000110000000011,0b01111001111111111101001001000000,0b00000001111111111000000110000000,0b01111110000000000000000000000000,
    0b00000000000000000000110000001011,0b01111000011010011101100111100000,0b00000001111111110000000110000000,0b01111111111110000000000000000000,
    0b00000000000000000000010000011111,0b00111000111110001000110111100000,0b00000011111111100000000000000000,0b00000011111111000000000000000000,
    0b00000000000000000000010000001111,0b00110000000000000000011111111100,0b00000011000000000000000000000000,0b00000011000000000000000000000000,
    0b00000000000000000000010000001011,0b10000000000000000000001100111100,0b00000011111111110000000000000000,0b00000011000000000000000000000000,
    0b00000000000000000000100000001001,0b11000000000000000000001110111000,0b00000000111111110000000110000000,0b00000111000000000000000000000000,
    0b00000000000000000001100000111110,0b11000000000000000000001111110000,0b00000000000000000000001110000000,0b00000110000000000000000000000000,
    0b00000000000000000001101001100011,0b11100000000000000000111111110000,0b00000000000000000000000000000000,0b00000110000000000000000000000000,
    0b00000000000000000001101001111111,0b10111111111111111111111111110000,0b00000000000000000000000000000000,0b00000100000000000000000000000000,
    0b00000000000000000000101000111101,0b11111111111111111011111111100000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000010111100011,0b11111111111001110001111111100000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011111111,0b11111111111001111011111111000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000111111,0b11111111111111110111111000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000011111,0b11111111111110111111111000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000
  },
  {
    0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000001100000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000110010100000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000001000100111000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011111111,0b10000000000000000000000000000000,0b00000000011111000101100000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000111111111,0b11110000000000000000000000000000,0b00000000111110000100110000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000110000000,0b01110000001111100000000000000000,0b00000000110011100110011000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000110000000,0b00110001111111110000001100000000,0b00000000010000110011011000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000110000000,0b00110001111000110000001111111000,0b00000000010000111111110111100000,0b00001000000000000000000000000000,
    0b00000000000000000000000110000000,0b00110000000000110000000011111100,0b00000000011000111111111111111100,0b00000110000000000000000000000000,
    0b00000000000000000000000110000000,0b00110000000000110000000000011100,0b00000000001111111011111000000111,0b00000100000000000000000000000000,
    0b00000000000000000000001111111111,0b01110000000000110000000000011000,0b00000000000111000110000000000001,0b11001000010000000000000000000000,
    0b00000000000000000000000111111111,0b11100000000000110001111111111000,0b00000000110000000000000000000000,0b01100001110000000000000000000000,
    0b00000000000000000000000000001011,0b11100000011111110001111111110000,0b00000001100000000100000000000000,0b00110000000100000000000000000000,
    0b00000000000000000000000000011000,0b00000000111111100001100000000000,0b00000011000000000010000000001100,0b00011000011100000000000000000000,
    0b00000000000000000000011111111110,0b00000001110000000011100000000000,0b00000010000000000111000000000000,0b00001100000000000000000000000000,
    0b00000000000000000000011111111111,0b11100001110000000011111111100000,0b00000100000000000100100000000001,0b00000100000000000000000000000000,
    0b00000000000000000000000000000001,0b11100001100000000000111111110000,0b00000100000000111010010000000011,0b10000110000000000000000000000000,
    0b00000000000000000000001111111110,0b00000001100000000000000000100000,0b00001100000000110011001100000011,0b10000010000000000000000000000000,
    0b00000000000000000000000111111111,0b10000001100000000111111000000000,0b00001100000000110111100111111111,0b11010010010000000000000000000000,
    0b00000000000000000000000111111111,0b00000001100000000111111111111000,0b00001100000010110111100001101001,0b11011001111000000000000000000000,
    0b00000000000000000000001111111110,0b00000000000000000000001111111100,0b00000100000111110011100011111000,0b10001101111000000000000000000000,
    0b00000000000000000000001100000000,0b00000000000000000000001100000000,0b00000100000011110011000000000000,0b00000111111111000000000000000000,
    0b00000000000000000000001111111111,0b00000000000000000000001100000000,0b00000100000010111000000000000000,0b00000011001111000000000000000000,
    0b00000000000000000000000011111111,0b00000001100000000000011100000000,0b00001000000010011100000000000000,0b00000011101110000000000000000000,
    0b00000000000000000000000000000000,0b00000011100000000000011000000000,0b00011000001111101100000000000000,0b00000011111100000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000011000000000,0b00011010011000111110000000000000,0b00001111111100000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000010000000000,0b00011010011111111011111111111111,0b11111111111100000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00001010001111011111111111111111,0b10111111111000000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000101111000111111111111100111,0b00011111111000000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000111111111111111111100111,0b10111111110000000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000001111111111111111111111,0b01111110000000000000000000000000,
    0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000111111111111111111011,0b11111110000000000000000000000000
  }
};

const int FRAME_COUNT = 2;
const int MS_PER_FRAME = 500;
uint16_t frame_timer = 0;
int current_frame = -1;

void _oled_process_frames(void) {
  if (timer_elapsed(frame_timer) <= MS_PER_FRAME) {
    return;
  }

  current_frame = (current_frame + 1) % FRAME_COUNT;
  const uint32_t *frame = FRAME_DATA[current_frame];

  oled_clear();
  for (int i=0; i<128; i++) {
    uint32_t vec = frame[i];

    for (int j=0; j<32; j++) {
      int pos = i * 32 + j;
      int y = pos / 128;
      int x = pos % 128;

      uint32_t mask = 0x80000000;
      if (vec & (mask >> j)) {
        oled_write_pixel(x, y, true);
      }
    }
  }
  
  frame_timer = timer_read();
}

bool oled_task_user(void) {
  _oled_process_frames();
  return false;
}
