/* Copyright 2021 Brandon Lewis
  * 
  * This program is free software: you can redistribute it and/or modify 
  * it under the terms of the GNU General Public License as published by 
  * the Free Software Foundation, either version 2 of the License, or 
  * (at your option) any later version. 
  * 
  * This program is distributed in the hope that it will be useful, 
  * but WITHOUT ANY WARRANTY; without even the implied warranty of 
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
  * GNU General Public License for more details. 
  * 
  * You should have received a copy of the GNU General Public License 
  * along with this program.  If not, see <http://www.gnu.org/licenses/>. 
  */

#include "fruitbar.h"

_S_ROTARY rotary_state = _S_VOLUME;
uint16_t num_timer = 0;
uint16_t fn_timer = 0;

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  if (record->event.pressed) {
    _oled_process_frames();
  }

  switch (keycode) {
    case _KC_ROTARY:
      if (record->event.pressed) {
        rotary_state = rotary_state == _S_VOLUME ? _S_BRIGHTNESS : _S_VOLUME;
      }
      return false;
    case _KC_NUM:
      if (record->event.pressed) {
        layer_on(_L_NUM);
      } else {
        if (timer_elapsed(num_timer) > 250) {
          layer_off(_L_NUM);
          layer_off(_L_FN);
        }
        num_timer = timer_read();
      }
      return false;
    case _KC_FN:
      if (record->event.pressed) {
        layer_on(_L_FN);
      } else {
        if (timer_elapsed(fn_timer) > 250) {
          layer_off(_L_FN);
          layer_off(_L_NUM);
        }
        fn_timer = timer_read();
      }
      return false;
    default:
      return true; // Process all other keycodes normally
  }
}

bool encoder_update_user(uint8_t index, bool clockwise) {
  clockwise = !clockwise; // It's inverted for some reason

  switch (rotary_state) {
    case _S_VOLUME:
      tap_code_delay(clockwise ? KC_KB_VOLUME_UP : KC_KB_VOLUME_DOWN, 10);
      return false;
    case _S_BRIGHTNESS:
      tap_code_delay(clockwise ? KC_BRIGHTNESS_UP : KC_BRIGHTNESS_DOWN, 10);
      return false;
    default:
      return false;
  }
}

const uint32_t FRAME_DATA[][128] = {
  {
    0b00000000000000000000000000000110,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000011001,0b01000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000100010,0b01110000000000000000000000000000,0b00000000111111111000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000001111100,0b01011000000000000000000000000000,0b00000001111111111111000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011111000,0b01001100000000000000000000000000,0b00000001100000000111000000111110,0b00000000000000000000000000000000,
    0b00000000000000000000000011001110,0b01100110000000000000000000000000,0b00000001100000000011000111111111,0b00000011000000000000000000000000,
    0b00000000000000000000000001000011,0b00110110000000000000000000000000,0b00000001100000000011000111100011,0b00000011111110000000000000000000,
    0b00000000000000000000000001000011,0b11111101111000000000100000000000,0b00000001100000000011000000000011,0b00000000111111000000000000000000,
    0b00000000000000000000000001100011,0b11111111111111000000011000000000,0b00000001100000000011000000000011,0b00000000000111000000000000000000,
    0b00000000000000000000000000111111,0b10111110000001110000010000000000,0b00000011111111110111000000000011,0b00000000000110000000000000000000,
    0b00000000000000000000000000011100,0b01100000000000011100100001000000,0b00000001111111111110000000000011,0b00011111111110000000000000000000,
    0b00000000000000000000000011000000,0b00000000000000000110000111000000,0b00000000000010111110000001111111,0b00011111111100000000000000000000,
    0b00000000000000000000000110000000,0b01000000000000000011000000010000,0b00000000000110000000000011111110,0b00011000000000000000000000000000,
    0b00000000000000000000001100000000,0b00100000000011000001100001110000,0b00000111111111100000000111000000,0b00111000000000000000000000000000,
    0b00000000000000000000001000000000,0b01110000000000000000110000000000,0b00000111111111111110000111000000,0b00111111111000000000000000000000,
    0b00000000000000000000010000000000,0b01001000000000010000010000000000,0b00000000000000011110000110000000,0b00001111111100000000000000000000,
    0b00000000000000000000010000000011,0b10100100000000111000011000000000,0b00000011111111100000000110000000,0b00000000001000000000000000000000,
    0b00000000000000000000110000000011,0b00110011000000111000001000000000,0b00000001111111111000000110000000,0b01111110000000000000000000000000,
    0b00000000000000000000110000000011,0b01111001111111111101001001000000,0b00000001111111110000000110000000,0b01111111111110000000000000000000,
    0b00000000000000000000110000001011,0b01111000011010011101100111100000,0b00000011111111100000000000000000,0b00000011111111000000000000000000,
    0b00000000000000000000010000011111,0b00111000111110001000110111100000,0b00000011000000000000000000000000,0b00000011000000000000000000000000,
    0b00000000000000000000010000001111,0b00110000000000000000011111111100,0b00000011111111110000000000000000,0b00000011000000000000000000000000,
    0b00000000000000000000100000001001,0b11000000000000000000001110111000,0b00000000111111110000000110000000,0b00000111000000000000000000000000,
    0b00000000000000000001100000111110,0b11000000000000000000001111110000,0b00000000000000000000001110000000,0b00000110000000000000000000000000,
    0b00000000000000000001101001100011,0b11100000000000000000111111110000,0b00000000000000000000000000000000,0b00000110000000000000000000000000,
    0b00000000000000000001101001111111,0b10111111111111111111111111110000,0b00000000000000000000000000000000,0b00000100000000000000000000000000,
    0b00000000000000000000101000111101,0b11111111111111111011111111100000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000010111100011,0b11111111111001110001111111100000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011111111,0b11111111111001111011111111000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000111111,0b11111111111111110111111000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000011111,0b11111111111110111111111000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000011111,0b11111111111110111111111000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000
  },
  {
    0b00000000000000000000000000000110,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000011001,0b01000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000100010,0b01110000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000001111100,0b01011000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011111000,0b01001100000000000000000000000000,0b00000000111111111000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011001110,0b01100110000000000000000000000000,0b00000001111111111111000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000001000011,0b00110110000000000000000000000000,0b00000001100000000111000000111110,0b00000000000000000000000000000000,
    0b00000000000000000000000001000011,0b11111101111000000000100000000000,0b00000001100000000011000111111111,0b00000011000000000000000000000000,
    0b00000000000000000000000001100011,0b11111111111111000000011000000000,0b00000001100000000011000111100011,0b00000011111110000000000000000000,
    0b00000000000000000000000000111111,0b10111110000001110000010000000000,0b00000001100000000011000000000011,0b00000000111111000000000000000000,
    0b00000000000000000000000000011100,0b01100000000000011100100001000000,0b00000001100000000011000000000011,0b00000000000111000000000000000000,
    0b00000000000000000000000011000000,0b00000000000000000110000111000000,0b00000011111111110111000000000011,0b00000000000110000000000000000000,
    0b00000000000000000000000110000000,0b01000000000000000011000000010000,0b00000001111111111110000000000011,0b00011111111110000000000000000000,
    0b00000000000000000000001100000000,0b00100000000011000001100001110000,0b00000000000010111110000001111111,0b00011111111100000000000000000000,
    0b00000000000000000000001000000000,0b01110000000000000000110000000000,0b00000000000110000000000011111110,0b00011000000000000000000000000000,
    0b00000000000000000000010000000000,0b01001000000000010000010000000000,0b00000111111111100000000111000000,0b00111000000000000000000000000000,
    0b00000000000000000000010000000011,0b10100100000000111000011000000000,0b00000111111111111110000111000000,0b00111111111000000000000000000000,
    0b00000000000000000000110000000011,0b00110011000000111000001000000000,0b00000000000000011110000110000000,0b00001111111100000000000000000000,
    0b00000000000000000000110000000011,0b01111001111111111101001001000000,0b00000011111111100000000110000000,0b00000000001000000000000000000000,
    0b00000000000000000000110000001011,0b01111000011010011101100111100000,0b00000001111111111000000110000000,0b01111110000000000000000000000000,
    0b00000000000000000000010000011111,0b00111000111110001000110111100000,0b00000001111111110000000110000000,0b01111111111110000000000000000000,
    0b00000000000000000000010000001111,0b00110000000000000000011111111100,0b00000011111111100000000000000000,0b00000011111111000000000000000000,
    0b00000000000000000000010000001011,0b10000000000000000000001100111100,0b00000011000000000000000000000000,0b00000011000000000000000000000000,
    0b00000000000000000000010000001011,0b10000000000000000000001100111100,0b00000011111111110000000000000000,0b00000011000000000000000000000000,
    0b00000000000000000000100000001001,0b11000000000000000000001110111000,0b00000000111111110000000110000000,0b00000111000000000000000000000000,
    0b00000000000000000001100000111110,0b11000000000000000000001111110000,0b00000000000000000000001110000000,0b00000110000000000000000000000000,
    0b00000000000000000001101001100011,0b11100000000000000000111111110000,0b00000000000000000000000000000000,0b00000110000000000000000000000000,
    0b00000000000000000001101001111111,0b10111111111111111111111111110000,0b00000000000000000000000000000000,0b00000100000000000000000000000000,
    0b00000000000000000000101000111101,0b11111111111111111011111111100000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000010111100011,0b11111111111001110001111111100000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000011111111,0b11111111111001111011111111000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
    0b00000000000000000000000000111111,0b11111111111111110111111000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,
  }
};

const int FRAME_COUNT = 2;
const int MS_PER_FRAME = 20;
uint16_t frame_timer = 0;
int current_frame = -1;

void _oled_process_frames(void) {
  if (timer_elapsed(frame_timer) <= MS_PER_FRAME) {
    return;
  }

  current_frame = (current_frame + 1) % FRAME_COUNT;
  const uint32_t *frame = FRAME_DATA[current_frame];

  oled_clear();
  for (int i=0; i<128; i++) {
    uint32_t vec = frame[i];

    for (int j=0; j<32; j++) {
      int pos = i * 32 + j;
      int y = pos / 128;
      int x = pos % 128;

      uint32_t mask = 0x80000000;
      if (vec & (mask >> j)) {
        oled_write_pixel(x, y, true);
      }
    }
  }
  
  frame_timer = timer_read();
}
